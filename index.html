<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LegalApp - Sistema Experto</title>

    <style>
        /* VARIABLES DE DISE√ëO (PERSONALIZABLES) */
        :root {
            --primary: #2563eb;
            --secondary: #1e293b;
            --bg: #f8fafc;
            --panel: #ffffff;
            --text: #0f172a;
            --radius: 14px;
        }

        /* MODO OSCURO */
        body.dark {
            --bg: #020617;
            --panel: #1e293b;
            --text: #f8fafc;
        }

        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            font-family: 'Segoe UI', system-ui;
            background: var(--bg);
            color: var(--text);
            transition: background 0.3s, color 0.3s, font-size 0.2s;
            max-width: 100%;
        }

        /* ===== AUTENTICACI√ìN ===== */
        .auth {
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .auth-box {
            background: var(--panel);
            padding: 40px;
            width: 400px;
            border-radius: var(--radius);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            text-align: center;
        }

        /* ===== LAYOUT PRINCIPAL ===== */
        .container {
            display: none;
            height: 100vh;
            flex-direction: row;
        }

        .sidebar {
            width: 260px;
            background: var(--secondary);
            color: white;
            padding: 25px;
            display: flex;
            flex-direction: column;
            transition: 0.3s;
        }

        .sidebar a {
            display: block;
            padding: 12px;
            margin-top: 10px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            cursor: pointer;
            text-decoration: none;
            color: white;
            transition: 0.2s;
        }

        .sidebar a:hover {
            background: var(--primary);
        }

        .main {
            flex: 1;
            padding: 40px;
            overflow-y: auto;
        }

        /* ===== COMPONENTES ===== */
        .card {
            background: var(--panel);
            padding: 25px;
            border-radius: var(--radius);
            margin-top: 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
            transition: 0.3s;
        }

        .setting {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        }

        input,
        select,
        button {
            width: 100%;
            padding: 12px;
            margin-top: 10px;
            border-radius: 10px;
            border: 1px solid #cbd5e1;
            font-size: 15px;
        }

        button {
            background: var(--primary);
            color: white;
            border: none;
            cursor: pointer;
            font-weight: bold;
        }

        button:hover {
            filter: brightness(1.1);
            transform: translateY(-1px);
        }

        .profile-img {
            width: 110px;
            height: 110px;
            border-radius: 50%;
            object-fit: cover;
            border: 4px solid var(--primary);
            margin: 0 auto 15px;
            display: block;
        }

        .hidden {
            display: none;
        }

        canvas {
            max-width: 100%;
            height: auto;
            border-radius: 10px;
            margin-top: 15px;
        }

        /* ===== CHATBOT UI ===== */
        .chat-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 300px;
            background: var(--panel);
            border-radius: var(--radius);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            border: 1px solid var(--primary);
            z-index: 1000;
        }

        .chat-header {
            background: var(--primary);
            color: white;
            padding: 10px;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            cursor: pointer;
        }

        #chat-body {
            height: 300px;
            overflow-y: auto;
            padding: 15px;
            font-size: 14px;
            display: none;
            flex-direction: column;
        }

        .msg {
            margin-bottom: 10px;
            padding: 8px;
            border-radius: 8px;
            max-width: 80%;
            line-height: 1.4;
        }

        .bot {
            background: #e2e8f0;
            align-self: flex-start;
            color: #1e293b;
        }

        .user {
            background: var(--primary);
            color: white;
            align-self: flex-end;
            margin-left: auto;
        }

        .chat-input {
            display: none;
            padding: 10px;
            border-top: 1px solid #eee;
        }

        .chat-input input {
            margin: 0;
            padding: 8px;
        }
    </style>
</head>

<body>

    <div class="auth" id="auth">
        <div class="auth-box">
            <h1 style="color: var(--primary)">‚öñÔ∏è LegalApp</h1>
            <p>Sistema Experto de Diagn√≥stico</p>

            <div id="authMenu">
                <button onclick="showSection('loginForm')">Iniciar Sesi√≥n</button>
                <button style="background: var(--secondary)" onclick="showSection('registerForm')">Crear Cuenta</button>
            </div>

            <div id="loginForm" class="hidden">
                <input id="loginUser" placeholder="Usuario">
                <input id="loginPass" type="password" placeholder="Contrase√±a">
                <button onclick="login()">Entrar</button>
                <a onclick="location.reload()"
                    style="font-size: 12px; cursor:pointer; display:block; margin-top:10px;">Volver</a>
            </div>

            <div id="registerForm" class="hidden">
                <input id="name" placeholder="Nombre completo">
                <input id="name" placeholder="Apellido Paterno" required>
                <input id="name" placeholder="Apellido Materno" required>
                <input id="email" placeholder="Correo electr√≥nico">
                <input id="regUser" placeholder="Crea un usuario">
                <input id="regPass" type="password" placeholder="Contrase√±a">

                <button onclick="register()">Registrarse</button>
                <a onclick="location.reload()"
                    style="font-size: 12px; cursor:pointer; display:block; margin-top:10px;">Volver</a>
            </div>
        </div>
    </div>

    <div class="container" id="app">
        <div class="sidebar" id="sidebar">
            <h2 style="font-size: 20px;">‚öñÔ∏è Panel Legal</h2>
            <hr style="opacity: 0.1; width: 100%;">
            <a onclick="diagnosis()">üìã Nuevo Diagn√≥stico</a>
            <a onclick="profile()">üë§ Mi Perfil</a>
            <a onclick="settings()">‚öôÔ∏è Configuraci√≥n</a>
            <a onclick="logout()" style="margin-top: auto; background: #ef4444;">Cerrar Sesi√≥n</a>
        </div>

        <div class="main" id="content">
        </div>
    </div>

    <div class="chat-container">
        <div class="chat-header" onclick="toggleChat()">
            <span>üí¨ Asistente Legal IA</span>
            <span id="chat-icon">‚ñ≤</span>
        </div>
        <div id="chat-body">
            <div class="msg bot">Hola, soy tu asistente legal. ¬øEn qu√© puedo ayudarte hoy?</div>
        </div>
        <div class="chat-input" id="chat-footer">
            <input type="text" id="chat-msg" placeholder="Escribe tu duda..."
                onkeypress="if(event.key==='Enter') sendChat()">
        </div>
    </div>

    <script>
        const $ = id => document.getElementById(id);

        /* ===== BASE DE CONOCIMIENTO (KB) ===== */
        const kb = {
            "Laboral": {
                "Despido Injustificado": [
                    { q: "¬øTrabaj√≥ m√°s de 3 meses?", w: 2 },
                    { q: "¬øLe notificaron por escrito?", w: 3 },
                    { q: "¬øFue por causa ajena a su conducta?", w: 5 },
                    { q: "¬øTiene pruebas/testigos?", w: 4 }
                ],
                "Acoso Laboral": [
                    { q: "¬øEs una conducta repetitiva?", w: 5 },
                    { q: "¬øAfecta su salud mental?", w: 3 },
                    { q: "¬øReport√≥ a RRHH anteriormente?", w: 2 }
                ]
            },
            "Civil": {
                "Incumplimiento de Contrato": [
                    { q: "¬øHay un contrato firmado?", w: 5 },
                    { q: "¬øSe venci√≥ el plazo acordado?", w: 4 },
                    { q: "¬øHubo da√±o econ√≥mico?", w: 3 }
                ]
            }
        };

        /* ===== L√ìGICA DE USUARIOS ===== */
        function showSection(id) {
            $("authMenu").classList.add("hidden");
            $("loginForm").classList.add("hidden");
            $("registerForm").classList.add("hidden");
            $(id).classList.remove("hidden");
        }

        function register() {
            const users = JSON.parse(localStorage.getItem("users")) || [];
            const u = $("reg-user").value.trim(); // Actualizado el ID

            if (users.find(x => x.username === u)) return alert("El usuario ya existe");

            const newUser = {
                name: $("reg-name").value,
                paterno: $("reg-paterno").value, // Nuevo
                materno: $("reg-materno").value, // Nuevo
                email: $("reg-email").value,
                username: u,
                password: $("reg-pass").value,
                photo: null,
                history: []
            };

            users.push(newUser);
            localStorage.setItem("users", JSON.stringify(users));
            localStorage.setItem("activeUser", JSON.stringify(newUser));
            location.reload();
        }

        function login() {
            const users = JSON.parse(localStorage.getItem("users")) || [];
            const u = $("loginUser").value;
            const p = $("loginPass").value;
            const user = users.find(x => x.username === u && x.password === p);

            if (!user) return alert("Datos incorrectos");
            localStorage.setItem("activeUser", JSON.stringify(user));
            showApp();
        }

        function logout() {
            localStorage.removeItem("activeUser");
            location.reload();
        }

        function showApp() {
            $("auth").style.display = "none";
            $("app").style.display = "flex";
            diagnosis();
        }

        /* ===== SISTEMA DE DIAGN√ìSTICO ===== */
        function diagnosis() {
            $("content").innerHTML = `
                <h2>ü©∫ Nuevo Diagn√≥stico Legal</h2>
                <div class="card">
                    <label>√Årea Legal:</label>
                    <select id="cat" onchange="loadCases()">
                        <option value="">-- Seleccionar --</option>
                        ${Object.keys(kb).map(x => `<option>${x}</option>`).join("")}
                    </select>
                    <div id="caseBox" class="hidden">
                        <label>Caso Espec√≠fico:</label>
                        <select id="caso" onchange="loadQs()"></select>
                    </div>
                </div>
                <div id="qs" class="card hidden"></div>
                <div id="res"></div>
            `;
        }

        function loadCases() {
            const cat = $("cat").value;
            if (!cat) return $("caseBox").classList.add("hidden");
            $("caseBox").classList.remove("hidden");
            $("caso").innerHTML = '<option value="">-- Seleccionar caso --</option>' +
                Object.keys(kb[cat]).map(x => `<option>${x}</option>`).join("");
        }

        function loadQs() {
            const cat = $("cat").value;
            const caso = $("caso").value;
            if (!caso) return $("qs").classList.add("hidden");

            $("qs").classList.remove("hidden");
            $("qs").innerHTML = `<h3>Responda con honestidad:</h3>`;
            kb[cat][caso].forEach((q, i) => {
                $("qs").innerHTML += `
                    <div style="margin-bottom:10px">
                        <label>${q.q}</label>
                        <select id="q${i}">
                            <option value="0">No / Falso</option>
                            <option value="1">S√≠ / Verdadero</option>
                        </select>
                    </div>`;
            });
            $("qs").innerHTML += `<button onclick="infer()">Generar Diagn√≥stico</button>`;
        }

        function infer() {
            const cat = $("cat").value;
            const caso = $("caso").value;
            let s = 0, maxS = 0;

            kb[cat][caso].forEach((q, i) => {
                s += (parseInt($(`q${i}`).value) * q.w);
                maxS += q.w;
            });

            const esProcedente = s > (maxS / 2);
            const statusText = esProcedente ? "PROCEDENTE" : "NO PROCEDENTE";
            const img = imgGen(caso, s, esProcedente);

            saveHistory(caso, s, img, statusText);

            $("res").innerHTML = `
                <div class="card" style="border-left: 10px solid ${esProcedente ? '#2563eb' : '#ef4444'}">
                    <h2 style="color: ${esProcedente ? '#2563eb' : '#ef4444'}">${statusText}</h2>
                    <p>An√°lisis completado para el caso de <b>${caso}</b>.</p>
                    <img src="${img}">
                </div>`;
        }

        function imgGen(caso, s, esProcedente) {
            const canvas = document.createElement("canvas");
            canvas.width = 500; canvas.height = 250;
            const ctx = canvas.getContext("2d");
            const color = esProcedente ? "#2563eb" : "#ef4444";
            ctx.fillStyle = esProcedente ? "#f0f7ff" : "#fff5f5";
            ctx.fillRect(0, 0, 500, 250);
            ctx.strokeStyle = color;
            ctx.lineWidth = 10;
            ctx.strokeRect(5, 5, 490, 240);
            ctx.fillStyle = color;
            ctx.font = "bold 26px Arial";
            ctx.fillText("DIAGN√ìSTICO LEGAL", 110, 50);
            ctx.fillStyle = "#1e293b";
            ctx.font = "20px Arial";
            ctx.fillText("Resultado: " + (esProcedente ? "Procedente" : "No Procedente"), 50, 110);
            ctx.fillText("Caso: " + caso, 50, 150);
            ctx.fillText("Puntaje T√©cnico: " + s + " pts", 50, 190);
            return canvas.toDataURL();
        }

        function saveHistory(caso, s, img, status) {
            let user = JSON.parse(localStorage.getItem("activeUser"));
            const record = { caso, s, img, status, date: new Date().toLocaleString() };
            user.history.unshift(record);
            localStorage.setItem("activeUser", JSON.stringify(user));
            const users = JSON.parse(localStorage.getItem("users"));
            const idx = users.findIndex(u => u.username === user.username);
            users[idx].history = user.history;
            localStorage.setItem("users", JSON.stringify(users));
        }

        function profile() {
            const user = JSON.parse(localStorage.getItem("activeUser"));
            $("content").innerHTML = `
                <h2>üë§ Mi Perfil</h2>
                <div class="card">
                    <img src="${user.photo || 'https://www.w3schools.com/howto/img_avatar.png'}" class="profile-img" id="pImg">
                    <input type="file" accept="image/*" onchange="updatePhoto(event)">
                    <p><b>Nombre:</b> ${user.name}</p>
                    <p><b>Usuario:</b> ${user.username}</p>
                    <p><b>Email:</b> ${user.email}</p>
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 30px;">
                    <h3>üìú Historial de Casos</h3>
                    <div style="display: flex; gap: 10px;">
                        <button onclick="window.print()" style="width: auto; background: #64748b; padding: 5px 15px;">Descargar PDF</button>
                        <button onclick="clearHistory()" style="width: auto; background: #ef4444; padding: 5px 15px;">Borrar Historial</button>
                    </div>
                </div>
                <div id="histList"></div>
            `;
            loadHistList();
        }

        function clearHistory() {
            if (confirm("¬øEliminar todo el historial?")) {
                let user = JSON.parse(localStorage.getItem("activeUser"));
                user.history = [];
                localStorage.setItem("activeUser", JSON.stringify(user));
                const users = JSON.parse(localStorage.getItem("users"));
                const idx = users.findIndex(u => u.username === user.username);
                users[idx].history = [];
                localStorage.setItem("users", JSON.stringify(users));
                profile();
            }
        }

        function loadHistList() {
            const user = JSON.parse(localStorage.getItem("activeUser"));
            if (!user.history.length) return $("histList").innerHTML = "No hay registros.";
            $("histList").innerHTML = user.history.map(h => `
                <div class="card" style="border-left: 5px solid ${h.status === 'PROCEDENTE' ? '#2563eb' : '#ef4444'}">
                    <p><b>${h.caso}</b> - ${h.date}</p>
                    <img src="${h.img}" style="width: 200px">
                </div>
            `).join("");
        }

        function updatePhoto(e) {
            const reader = new FileReader();
            reader.onload = () => {
                let user = JSON.parse(localStorage.getItem("activeUser"));
                user.photo = reader.result;
                localStorage.setItem("activeUser", JSON.stringify(user));
                $("pImg").src = reader.result;
            };
            reader.readAsDataURL(e.target.files[0]);
        }

        /* ===== CONFIGURACI√ìN AVANZADA DE IU ===== */
        function settings() {
            $("content").innerHTML = `
        <h2>‚öôÔ∏è Personalizaci√≥n de la Interfaz</h2>
        <p>Ajusta la apariencia de LegalApp a tu gusto. Los cambios se aplican en tiempo real.</p>

        <div class="card">
            <h3>üé® Colores y Temas</h3>
            
            <div class="setting">
                <span>üåó Modo de Color</span>
                <select onchange="document.body.className = this.value">
                    <option value="">‚òÄÔ∏è Claro</option>
                    <option value="dark">üåô Oscuro</option>
                </select>
            </div>

            <div class="setting">
                <span>üîµ Color Primario (Botones y Enlaces)</span>
                <input type="color" value="#2563eb" 
                    onchange="document.documentElement.style.setProperty('--primary', this.value)">
            </div>

            <div class="setting">
                <span>üåë Color Secundario (Barra Lateral)</span>
                <input type="color" value="#1e293b" 
                    onchange="document.documentElement.style.setProperty('--secondary', this.value)">
            </div>
        </div>

        <div class="card">
            <h3>üî§ Tipograf√≠a y Texto</h3>

            <div class="setting">
                <span>üî° Fuente del Sistema</span>
                <select onchange="document.body.style.fontFamily = this.value">
                    <option value="'Segoe UI', system-ui">Predeterminada</option>
                    <option value="'Courier New', monospace">Monoespaciada</option>
                    <option value="'Georgia', serif">Elegante (Serif)</option>
                    <option value="'Arial', sans-serif">Limpia (Arial)</option>
                </select>
            </div>

            <div class="setting">
                <span>üìè Tama√±o de Fuente</span>
                <select onchange="document.body.style.fontSize = this.value">
                    <option value="14px">Peque√±o</option>
                    <option value="16px" selected>Normal</option>
                    <option value="18px">Grande</option>
                    <option value="20px">Muy Grande</option>
                </select>
            </div>

            <div class="setting">
                <span>‚ÜïÔ∏è Espaciado entre l√≠neas (Lectura)</span>
                <select onchange="document.body.style.lineHeight = this.value">
                    <option value="1.2">Compacto</option>
                    <option value="1.6" selected>Normal</option>
                    <option value="2">Espacioso</option>
                </select>
            </div>
        </div>

        <div class="card">
            <h3>üìê Dise√±o y Estructura</h3>

            <div class="setting">
                <span>üîÑ Posici√≥n de la Barra Lateral</span>
                <select onchange="document.getElementById('app').style.flexDirection = this.value">
                    <option value="row">Izquierda</option>
                    <option value="row-reverse">Derecha</option>
                </select>
            </div>

            <div class="setting">
                <span>üñ•Ô∏è Ancho de la Aplicaci√≥n</span>
                <select onchange="document.body.style.maxWidth = this.value; document.body.style.margin = 'auto'">
                    <option value="100%">Ancho Completo</option>
                    <option value="1200px">Centrado (Boxed)</option>
                </select>
            </div>

            <div class="setting">
                <span>üßà Redondeado de Esquinas (Bordes)</span>
                <select onchange="document.documentElement.style.setProperty('--radius', this.value)">
                    <option value="0px">Cuadrado</option>
                    <option value="8px">Suave</option>
                    <option value="14px" selected>Redondeado</option>
                    <option value="30px">Muy Redondeado</option>
                </select>
            </div>
        </div>

        <div class="card">
            <h3>‚ú® Efectos Visuales</h3>

            <div class="setting">
                <span>üé¨ Animaciones de Interfaz</span>
                <select onchange="document.body.style.transition = this.value == 'on' ? '.3s' : '0s'">
                    <option value="on">Activadas</option>
                    <option value="off">Desactivadas</option>
                </select>
            </div>

            <div class="setting">
                <span>üë§ Sombreado de Tarjetas</span>
                <select onchange="const cards = document.querySelectorAll('.card'); 
                    cards.forEach(c => c.style.boxShadow = this.value)">
                    <option value="none">Sin sombra</option>
                    <option value="0 5px 20px rgba(0,0,0,0.08)">Sutil</option>
                    <option value="0 15px 35px rgba(0,0,0,0.2)">Pronunciada</option>
                </select>
            </div>

            <div class="setting">
                <span>üîç Opacidad de la Barra Lateral</span>
                <input type="range" min="0.5" max="1" step="0.1" value="1" 
                    onchange="document.querySelector('.sidebar').style.opacity = this.value">
            </div>
        </div>
    `;
        }

        /* ===== CHATBOT CON IA REAL (HUGGING FACE) ===== */
        function toggleChat() {
            const isOpen = $("chat-body").style.display === "flex";
            $("chat-body").style.display = isOpen ? "none" : "flex";
            $("chat-footer").style.display = isOpen ? "none" : "block";
            $("chat-icon").innerText = isOpen ? "‚ñ≤" : "‚ñº";
        }



        function appendMsg(text, type, id = null) {
            const msgDiv = document.createElement("div");
            msgDiv.className = `msg ${type}`;
            msgDiv.innerText = text;
            if (id) msgDiv.id = id;
            $("chat-body").appendChild(msgDiv);
            $("chat-body").scrollTop = $("chat-body").scrollHeight;
        }

        window.onload = () => { if (localStorage.getItem("activeUser")) showApp(); };
    </script>
</body>

</html>